<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản Lý Nhà Nghỉ</title>
  <!-- Core Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.25.2/babel.min.js" crossorigin="anonymous"></script>
  <!-- Chart.js with fallback -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous" defer></script>
  <script>
    if (!window.Chart) {
      document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer><\/script>');
    }
  </script>
  <!-- Additional Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/react-datepicker@7.3.0/dist/react-datepicker.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-select@5.8.0/dist/react-select.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js" crossorigin="anonymous" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/react-draggable@4.4.6/build/web/react-draggable.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.socket.io/4.8.0/socket.io.min.js" crossorigin="anonymous"></script>
  <!-- Styles -->
  <link rel="stylesheet" href="/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/react-datepicker@7.3.0/dist/react-datepicker.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/react-select@5.8.0/dist/react-select.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    .animate-fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    @media print { .print-hidden { display: none; } .print-content { background: none; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, lazy, Suspense } = React;
    const Draggable = window.ReactDraggable.default;

    // Lazy-load components
    const ToastContainer = lazy(() => Promise.resolve({
      default: ({ toasts, removeToast }) => (
        <div className="fixed bottom-4 right-4 space-y-2 z-50" role="region" aria-live="polite">
          {toasts.slice(-3).map(toast => (
            <div
              key={toast.id}
              className={`p-4 rounded-lg shadow-lg text-white flex items-center space-x-2 animate-fade-in
                ${toast.type === 'error' ? 'bg-red-500' : toast.type === 'warning' ? 'bg-yellow-500' : toast.type === 'info' ? 'bg-blue-500' : 'bg-green-500'}`}
              role="alert"
            >
              <span>{toast.message}</span>
              {toast.action && (
                <button
                  onClick={() => toast.action.callback()}
                  className="underline hover:text-gray-200"
                  aria-label={toast.action.label}
                >
                  {toast.action.label}
                </button>
              )}
              <button
                onClick={() => removeToast(toast.id)}
                className="text-white hover:text-gray-200"
                aria-label="Đóng thông báo"
              >
                ✕
              </button>
            </div>
          ))}
        </div>
      )
    }));

    const InvoicePopup = lazy(() => Promise.resolve({
      default: ({ invoice, onClose }) => {
        const { jsPDF } = window.jspdf;
        const formatHours = (hours) => {
          const totalMinutes = Math.round(hours * 60);
          const h = Math.floor(totalMinutes / 60);
          const m = totalMinutes % 60;
          return `${h} giờ ${m} phút`;
        };

        const handlePrint = () => window.print();
        const handleExportPDF = () => {
          const doc = new jsPDF();
          doc.setFontSize(16);
          doc.text(`Hóa Đơn Phòng ${invoice.roomNumber}`, 10, 10);
          doc.setFontSize(12);
          doc.text(`Thời gian vào: ${new Date(invoice.checkInTime).toLocaleString('vi-VN')}`, 10, 20);
          doc.text(`Thời gian ra: ${new Date(invoice.checkOutTime).toLocaleString('vi-VN')}`, 10, 30);
          doc.text(`Số giờ sử dụng: ${formatHours(invoice.hoursUsed)}`, 10, 40);
          doc.text(`Sản phẩm: ${invoice.items.join(', ') || 'Không có'}`, 10, 50);
          doc.text(`Phụ thu: ${invoice.surcharge.amount.toLocaleString('vi-VN')} VND (${invoice.surcharge.note || 'Không'})`, 10, 60);
          doc.text(`Tổng tiền: ${invoice.total.toLocaleString('vi-VN')} VND`, 10, 70);
          doc.save(`hoa_don_phong_${invoice.roomNumber}.pdf`);
        };

        return (
          <Draggable>
            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fade-in print-content" role="dialog" aria-modal="true">
              <div className="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full modal-content print:bg-white print:shadow-none">
                <h3 className="text-xl font-semibold mb-4 print:text-center" id="invoice-title">Hóa Đơn Phòng {invoice.roomNumber}</h3>
                <table className="w-full text-left border-collapse print:border print:border-gray-300">
                  <tbody>
                    <tr className="border-b print:border-gray-300">
                      <td className="py-2 font-medium">Thời gian vào:</td>
                      <td className="py-2">{new Date(invoice.checkInTime).toLocaleString('vi-VN')}</td>
                    </tr>
                    <tr className="border-b print:border-gray-300">
                      <td className="py-2 font-medium">Thời gian ra:</td>
                      <td className="py-2">{new Date(invoice.checkOutTime).toLocaleString('vi-VN')}</td>
                    </tr>
                    <tr className="border-b print:border-gray-300">
                      <td className="py-2 font-medium">Số giờ sử dụng:</td>
                      <td className="py-2">{formatHours(invoice.hoursUsed)}</td>
                    </tr>
                    <tr className="border-b print:border-gray-300">
                      <td className="py-2 font-medium">Sản phẩm:</td>
                      <td className="py-2">{invoice.items.join(', ') || 'Không có'}</td>
                    </tr>
                    <tr className="border-b print:border-gray-300">
                      <td className="py-2 font-medium">Phụ thu:</td>
                      <td className="py-2">{invoice.surcharge.amount.toLocaleString('vi-VN')} VND ({invoice.surcharge.note || 'Không'})</td>
                    </tr>
                    <tr className="border-b print:border-gray-300">
                      <td className="py-2 font-medium">Tổng tiền:</td>
                      <td className="py-2 font-bold">{invoice.total.toLocaleString('vi-VN')} VND</td>
                    </tr>
                  </tbody>
                </table>
                <div className="flex justify-end mt-4 space-x-2 print-hidden">
                  <button
                    onClick={handlePrint}
                    className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                    aria-label="In hóa đơn"
                  >
                    In
                  </button>
                  <button
                    onClick={handleExportPDF}
                    className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                    aria-label="Xuất PDF"
                  >
                    Xuất PDF
                  </button>
                  <button
                    onClick={onClose}
                    className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                    aria-label="Đóng hóa đơn"
                  >
                    Đóng
                  </button>
                </div>
              </div>
            </div>
          </Draggable>
        );
      }
    }));

    const App = React.memo(() => {
      const [rooms, setRooms] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [selectedRoom, setSelectedRoom] = useState(null);
      const [pin, setPin] = useState('');
      const [isAdmin, setIsAdmin] = useState(false);
      const [prices, setPrices] = useState({ firstHour: 90000, extraHour: 20000, overnight: 200000 });
      const [report, setReport] = useState({ daily: 0, weekly: 0, monthly: 0 });
      const [checkInData, setCheckInData] = useState({
        items: [],
        surcharge: { amount: 0, note: '' },
        type: 'hourly',
        cccd: '',
        fullName: '',
      });
      const [loading, setLoading] = useState(false);
      const [activeTab, setActiveTab] = useState(localStorage.getItem('activeTab') || 'prices');
      const [manualInventory, setManualInventory] = useState({ name: '', quantity: 0, purchasePrice: 0, salePrice: 0 });
      const [productPrices, setProductPrices] = useState({});
      const [toasts, setToasts] = useState([]);
      const [invoice, setInvoice] = useState(null);
      const [transactions, setTransactions] = useState([]);
      const [dateRange, setDateRange] = useState([new Date(), new Date()]);
      const [filter, setFilter] = useState({ room: null, type: null });
      const [bulkInventory, setBulkInventory] = useState([{ name: '', quantity: 0, purchasePrice: 0, salePrice: 0 }]);
      const socket = useMemo(() => io(), []);

      // Fetch initial data and set up WebSocket
      useEffect(() => {
        fetchData();
        const interval = setInterval(() => setRooms(prev => [...prev]), 60000); // Refresh UI every minute
        socket.on('roomUpdate', setRooms);
        socket.on('inventoryUpdate', setInventory);
        return () => {
          clearInterval(interval);
          socket.disconnect();
        };
      }, [socket]);

      // Persist active tab
      useEffect(() => {
        localStorage.setItem('activeTab', activeTab);
      }, [activeTab]);

      // Toast management
      const addToast = useCallback((message, type, action = null) => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type, action }]);
        setTimeout(() => removeToast(id), 5000);
      }, []);

      const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(toast => toast.id !== id));
      }, []);

      // Fetch data
      const fetchData = useCallback(async () => {
        setLoading(true);
        try {
          const [roomsRes, inventoryRes, reportRes, transactionsRes] = await Promise.all([
            axios.get('/api/rooms'),
            axios.get('/api/inventory'),
            axios.get('/api/reports'),
            axios.get('/api/transactions'),
          ]);
          setRooms(roomsRes.data);
          setInventory(inventoryRes.data);
          setReport(reportRes.data);
          setTransactions(transactionsRes.data);
        } catch (error) {
          addToast(`Lỗi khi lấy dữ liệu: ${error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [addToast]);

      // Check-in handler
      const handleCheckIn = useCallback(async (roomId) => {
        setLoading(true);
        try {
          await axios.post('/api/checkin', {
            roomId,
            items: checkInData.items,
            checkInTime: new Date(),
            type: checkInData.type,
            cccd: checkInData.cccd,
            fullName: checkInData.fullName,
          });
          await fetchData();
          setCheckInData({ items: [], surcharge: { amount: 0, note: '' }, type: 'hourly', cccd: '', fullName: '' });
          setSelectedRoom(null);
          addToast('Check-in thành công', 'success');
        } catch (error) {
          addToast(`Lỗi khi check-in: ${error.response?.data?.error || error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [checkInData, fetchData, addToast]);

      // Check-out handler
      const handleCheckOut = useCallback(async (roomId) => {
        setLoading(true);
        try {
          const response = await axios.post('/api/checkout', { roomId, surcharge: checkInData.surcharge });
          const { total, checkInTime, checkOutTime, hoursUsed, items } = response.data;
          const room = rooms.find(r => r._id === roomId);
          const itemDetails = await Promise.all(
            items.map(async (item) => {
              const inventoryItem = inventory.find(i => i._id === item.itemId);
              return `${inventoryItem.name} x${item.quantity} (${(inventoryItem.salePrice * item.quantity).toLocaleString('vi-VN')} VND)`;
            })
          );
          setInvoice({
            roomNumber: room.number,
            checkInTime,
            checkOutTime,
            hoursUsed,
            items: itemDetails,
            surcharge: checkInData.surcharge,
            total,
          });
          await fetchData();
          setCheckInData({ items: [], surcharge: { amount: 0, note: '' }, type: 'hourly', cccd: '', fullName: '' });
          setSelectedRoom(null);
          addToast('Check-out thành công', 'success', {
            label: 'Hoàn tác',
            callback: async () => {
              await axios.post('/api/undo-checkout', { roomId });
              await fetchData();
              addToast('Hoàn tác check-out thành công', 'success');
            },
          });
        } catch (error) {
          addToast(`Lỗi khi check-out: ${error.response?.data?.error || error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [checkInData, rooms, inventory, fetchData, addToast]);

      // Clean room handler
      const handleCleanRoom = useCallback(async (roomId) => {
        if (window.confirm('Xác nhận phòng đã được dọn sạch?')) {
          setLoading(true);
          try {
            await axios.post('/api/clean-room', { roomId });
            await fetchData();
            setSelectedRoom(null);
            addToast('Phòng đã được dọn sạch', 'success');
          } catch (error) {
            addToast(`Lỗi khi dọn phòng: ${error.response?.data?.error || error.message}`, 'error');
          } finally {
            setLoading(false);
          }
        }
      }, [fetchData, addToast]);

      // Admin login
      const handleAdminLogin = useCallback(() => {
        if (pin === '123456') {
          setIsAdmin(true);
          setPin('');
          addToast('Đăng nhập admin thành công', 'success');
        } else {
          addToast('Mã PIN không đúng', 'error');
        }
      }, [pin, addToast]);

      // Update prices
      const handlePriceUpdate = useCallback(async () => {
        setLoading(true);
        try {
          await axios.post('/api/prices', prices);
          addToast('Cập nhật giá thành công', 'success');
        } catch (error) {
          addToast(`Lỗi khi cập nhật giá: ${error.response?.data?.error || error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [prices, addToast]);

      // Excel import
      const handleExcelImport = useCallback(async (event) => {
        setLoading(true);
        try {
          const file = event.target.files[0];
          if (!file) throw new Error('Vui lòng chọn file Excel');
          const formData = new FormData();
          formData.append('file', file);
          await axios.post('/api/inventory/import', formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
          });
          await fetchData();
          addToast('Nhập kho thành công', 'success');
        } catch (error) {
          addToast(`Lỗi khi nhập kho: ${error.response?.data?.error || error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [fetchData, addToast]);

      // Manual inventory
      const handleManualInventory = useCallback(async () => {
        if (!manualInventory.name || manualInventory.quantity < 0 || manualInventory.purchasePrice < 0) {
          addToast('Tên, số lượng và giá nhập là bắt buộc, không được âm', 'warning');
          return;
        }
        setLoading(true);
        try {
          await axios.post('/api/inventory/price', {
            name: manualInventory.name,
            quantity: manualInventory.quantity,
            purchasePrice: manualInventory.purchasePrice,
            salePrice: manualInventory.salePrice || 0,
          });
          await fetchData();
          setManualInventory({ name: '', quantity: 0, purchasePrice: 0, salePrice: 0 });
          addToast('Thêm sản phẩm thành công', 'success');
        } catch (error) {
          addToast(`Lỗi khi thêm sản phẩm: ${error.response?.data?.error || error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [manualInventory, fetchData, addToast]);

      // Bulk inventory
      const handleBulkInventory = useCallback(async () => {
        const validItems = bulkInventory.filter(item => item.name && item.quantity >= 0 && item.purchasePrice >= 0);
        if (!validItems.length) {
          addToast('Vui lòng nhập ít nhất một sản phẩm hợp lệ', 'warning');
          return;
        }
        setLoading(true);
        try {
          await axios.post('/api/inventory/bulk', validItems);
          await fetchData();
          setBulkInventory([{ name: '', quantity: 0, purchasePrice: 0, salePrice: 0 }]);
          addToast('Nhập kho hàng loạt thành công', 'success');
        } catch (error) {
          addToast(`Lỗi khi nhập kho: ${error.response?.data?.error || error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [bulkInventory, fetchData, addToast]);

      // Update product prices
      const handleProductPriceUpdate = useCallback(async () => {
        setLoading(true);
        try {
          await Promise.all(
            Object.entries(productPrices).map(([id, salePrice]) =>
              axios.post('/api/inventory/price', { id, salePrice: parseInt(salePrice) || 0 })
            )
          );
          setProductPrices({});
          await fetchData();
          addToast('Cập nhật giá sản phẩm thành công', 'success');
        } catch (error) {
          addToast(`Lỗi khi cập nhật giá sản phẩm: ${error.response?.data?.error || error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      }, [productPrices, fetchData, addToast]);

      // Room styling
      const getRoomColor = useCallback((status) => ({
        vacant: 'bg-green-100 text-green-800',
        occupied: 'bg-blue-100 text-blue-800',
        dirty: 'bg-yellow-100 text-yellow-800',
      }[status] || 'bg-gray-100 text-gray-800'), []);

      const getRoomIcon = useCallback((status) => ({
        vacant: '✔️',
        occupied: '👤',
        dirty: '🧹',
      }[status] || '❓'), []);

      const getCurrentHours = useCallback((checkInTime) => {
        if (!checkInTime) return '0 giờ 0 phút';
        const totalMinutes = Math.round((new Date() - new Date(checkInTime)) / (1000 * 60));
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours} giờ ${minutes} phút`;
      }, []);

      // Filtered transactions
      const filteredTransactions = useMemo(() => {
        return transactions.filter((t) => {
          const roomMatch = !filter.room || t.roomId === filter.room?.value;
          const typeMatch = !filter.type || t.type === filter.type?.value;
          const dateMatch = !dateRange[0] || !dateRange[1] ||
            (new Date(t.checkOutTime) >= dateRange[0] && new Date(t.checkOutTime) <= dateRange[1]);
          return roomMatch && typeMatch && dateMatch;
        });
      }, [transactions, filter, dateRange]);

      // Analytics
      const analytics = useMemo(() => {
        const roomUsage = {};
        const itemSales = {};
        const hourlyRevenue = Array(24).fill(0);

        transactions.forEach(t => {
          roomUsage[t.roomId] = (roomUsage[t.roomId] || 0) + 1;
          t.items.forEach(item => {
            itemSales[item.itemId] = (itemSales[item.itemId] || 0) + item.quantity;
          });
          const hour = new Date(t.checkInTime).getHours();
          hourlyRevenue[hour] += t.total;
        });

        const topRoom = Object.entries(roomUsage).sort((a, b) => b[1] - a[1])[0];
        const topItem = Object.entries(itemSales).sort((a, b) => b[1] - a[1])[0];
        const peakHour = hourlyRevenue.indexOf(Math.max(...hourlyRevenue));

        return {
          topRoom: topRoom ? { id: topRoom[0], count: topRoom[1] } : null,
          topItem: topItem ? { id: topItem[0], count: topItem[1] } : null,
          peakHour,
        };
      }, [transactions]);

      // Chart data
      const chartData = useMemo(() => ({
        labels: ['Ngày', 'Tuần', 'Tháng'],
        datasets: [{
          label: 'Doanh thu (VND)',
          data: [report.daily, report.weekly, report.monthly],
          backgroundColor: ['#2563eb', '#4a90e2', '#90cdf4'],
        }],
      }), [report]);

      // Render chart
      useEffect(() => {
        const ctx = document.getElementById('revenueChart')?.getContext('2d');
        if (ctx && window.Chart) {
          const chart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true, title: { display: true, text: 'Doanh thu (VND)' } } },
              plugins: { legend: { display: false } },
            },
          });
          return () => chart.destroy();
        }
      }, [chartData]);

      return (
        <Suspense fallback={<div className="text-center p-4">Đang tải...</div>}>
          <div className="min-h-screen bg-gray-50">
            <ToastContainer toasts={toasts} removeToast={removeToast} />
            {invoice && <InvoicePopup invoice={invoice} onClose={() => setInvoice(null)} />}

            {/* Header */}
            <header className="bg-blue-600 text-white p-4 shadow-lg">
              <div className="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <h1 className="text-2xl md:text-3xl font-bold mb-2 sm:mb-0">Quản Lý Nhà Nghỉ</h1>
                {!isAdmin ? (
                  <div className="flex items-center space-x-2 w-full sm:w-auto">
                    <input
                      type="password"
                      placeholder="Mã PIN Admin"
                      value={pin}
                      onChange={(e) => setPin(e.target.value)}
                      className="border p-2 rounded text-gray-800 flex-grow sm:flex-grow-0"
                      aria-label="Mã PIN Admin"
                    />
                    <button
                      onClick={handleAdminLogin}
                      className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                      disabled={loading}
                    >
                      Đăng nhập
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => setIsAdmin(false)}
                    className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                    aria-label="Đăng xuất admin"
                  >
                    Đăng xuất
                  </button>
                )}
              </div>
            </header>

            {/* Main Content */}
            <main className="container mx-auto p-4 md:p-6">
              {loading && (
                <div className="text-center text-blue-600 mb-4 flex items-center justify-center">
                  <svg className="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" />
                  </svg>
                  Đang tải...
                </div>
              )}

              {/* Room List */}
              <section className="mb-8 bg-white p-6 rounded-lg shadow-md">
                <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
                  <h2 className="text-xl md:text-2xl font-semibold mb-2 sm:mb-0">Trạng Thái Phòng</h2>
                  <button
                    onClick={fetchData}
                    className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                    aria-label="Làm mới dữ liệu"
                  >
                    Làm mới
                  </button>
                </div>
                {['2', '3', '4'].map(floor => (
                  <div key={floor} className="mb-6">
                    <h3 className="text-lg md:text-xl font-medium mb-2">Tầng {floor}</h3>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                      {rooms.filter(room => room.floor === floor).map(room => (
                        <div
                          key={room._id}
                          className={`relative p-4 rounded-lg ${getRoomColor(room.status)} text-center cursor-pointer shadow-md hover:shadow-lg transition-shadow group`}
                          onClick={() => setSelectedRoom(room)}
                          role="button"
                          aria-label={`Phòng ${room.number}, trạng thái: ${room.status}`}
                        >
                          <div className="flex items-center justify-center space-x-2">
                            <span>{getRoomIcon(room.status)}</span>
                            <span>Phòng {room.number}</span>
                          </div>
                          {room.status === 'occupied' && (
                            <div className="text-sm mt-2">
                              {room.type === 'overnight' ? 'Qua đêm' : 'Nghỉ giờ'}
                              <br />
                              Vào: {new Date(room.checkInTime).toLocaleTimeString('vi-VN')}
                              <br />
                              Đã dùng: {getCurrentHours(room.checkInTime)}
                            </div>
                          )}
                          <div className="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded p-2 -top-10 left-1/2 transform -translate-x-1/2 z-10">
                            {room.status === 'occupied'
                              ? `Vào: ${new Date(room.checkInTime).toLocaleString('vi-VN')}, Loại: ${room.type === 'overnight' ? 'Qua đêm' : 'Nghỉ giờ'}`
                              : `Trạng thái: ${room.status === 'vacant' ? 'Trống' : 'Cần dọn'}`}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </section>

              {/* Check-in/Check-out Modal */}
              {selectedRoom && (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fade-in" role="dialog" aria-modal="true">
                  <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full modal-content">
                    <h3 className="text-xl font-semibold mb-4" id="room-modal-title">
                      {selectedRoom.status === 'dirty' ? `Xác nhận dọn Phòng ${selectedRoom.number}` : `Quản lý Phòng ${selectedRoom.number}`}
                    </h3>
                    {selectedRoom.status === 'dirty' ? (
                      <div>
                        <p className="mb-4">Phòng cần dọn dẹp. Xác nhận chuyển sang trạng thái trống?</p>
                        <div className="flex justify-end space-x-2">
                          <button
                            onClick={() => handleCleanRoom(selectedRoom._id)}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            disabled={loading}
                            aria-label="Xác nhận dọn phòng"
                          >
                            Xác nhận
                          </button>
                          <button
                            onClick={() => setSelectedRoom(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                            aria-label="Đóng modal"
                          >
                            Đóng
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div>
                        {selectedRoom.status === 'vacant' && (
                          <>
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1" htmlFor="room-type">Loại nghỉ:</label>
                              <select
                                id="room-type"
                                value={checkInData.type}
                                onChange={(e) => setCheckInData({ ...checkInData, type: e.target.value })}
                                className="border p-2 w-full rounded"
                                aria-label="Loại nghỉ"
                              >
                                <option value="hourly">Nghỉ giờ</option>
                                <option value="overnight">Qua đêm</option>
                              </select>
                            </div>
                            {checkInData.type === 'overnight' && (
                              <>
                                <div className="mb-4">
                                  <label className="block text-sm font-medium mb-1" htmlFor="cccd">CCCD:</label>
                                  <input
                                    id="cccd"
                                    type="text"
                                    placeholder="Số CCCD"
                                    value={checkInData.cccd}
                                    onChange={(e) => setCheckInData({ ...checkInData, cccd: e.target.value })}
                                    className="border p-2 w-full rounded"
                                    aria-label="Số CCCD"
                                  />
                                </div>
                                <div className="mb-4">
                                  <label className="block text-sm font-medium mb-1" htmlFor="fullName">Họ Tên:</label>
                                  <input
                                    id="fullName"
                                    type="text"
                                    placeholder="Họ và Tên"
                                    value={checkInData.fullName}
                                    onChange={(e) => setCheckInData({ ...checkInData, fullName: e.target.value })}
                                    className="border p-2 w-full rounded"
                                    aria-label="Họ và Tên"
                                  />
                                </div>
                              </>
                            )}
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1">Chọn sản phẩm:</label>
                              {inventory.map(item => (
                                <div key={item._id} className="flex items-center mb-2">
                                  <input
                                    type="number"
                                    min="0"
                                    max={item.quantity}
                                    placeholder="Số lượng"
                                    onChange={(e) => {
                                      const quantity = parseInt(e.target.value) || 0;
                                      const items = checkInData.items.filter(i => i.itemId !== item._id);
                                      if (quantity > 0) items.push({ itemId: item._id, quantity });
                                      setCheckInData({ ...checkInData, items });
                                    }}
                                    className="border p-2 w-20 mr-2 rounded"
                                    aria-label={`Số lượng ${item.name}`}
                                  />
                                  <span>{item.name} (Tồn: {item.quantity})</span>
                                </div>
                              ))}
                            </div>
                          </>
                        )}
                        {selectedRoom.status === 'occupied' && (
                          <>
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1" htmlFor="surcharge-amount">Phụ thu (VND):</label>
                              <input
                                id="surcharge-amount"
                                type="number"
                                placeholder="0"
                                value={checkInData.surcharge.amount}
                                onChange={(e) => setCheckInData({
                                  ...checkInData,
                                  surcharge: { ...checkInData.surcharge, amount: parseInt(e.target.value) || 0 }
                                })}
                                className="border p-2 w-full rounded"
                                aria-label="Phụ thu"
                              />
                            </div>
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1" htmlFor="surcharge-note">Ghi chú phụ thu:</label>
                              <input
                                id="surcharge-note"
                                type="text"
                                placeholder="Ghi chú"
                                value={checkInData.surcharge.note}
                                onChange={(e) => setCheckInData({
                                  ...checkInData,
                                  surcharge: { ...checkInData.surcharge, note: e.target.value }
                                })}
                                className="border p-2 w-full rounded"
                                aria-label="Ghi chú phụ thu"
                              />
                            </div>
                          </>
                        )}
                        <div className="flex justify-end space-x-2">
                          {selectedRoom.status === 'vacant' && (
                            <button
                              onClick={() => handleCheckIn(selectedRoom._id)}
                              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                              disabled={loading || (checkInData.type === 'overnight' && (!checkInData.cccd || !checkInData.fullName))}
                              aria-label="Check-in phòng"
                            >
                              Check-In
                            </button>
                          )}
                          {selectedRoom.status === 'occupied' && (
                            <button
                              onClick={() => handleCheckOut(selectedRoom._id)}
                              className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                              disabled={loading}
                              aria-label="Check-out phòng"
                            >
                              Check-Out
                            </button>
                          )}
                          <button
                            onClick={() => setSelectedRoom(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                            aria-label="Đóng modal"
                          >
                            Đóng
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Admin Panel */}
              {isAdmin && (
                <section className="mb-8 bg-white p-6 rounded-lg shadow-md">
                  <h2 className="text-xl md:text-2xl font-semibold mb-4">Bảng Quản Trị</h2>
                  <div className="flex flex-wrap border-b mb-4">
                    {['prices', 'inventory', 'productPrices', 'transactions', 'analytics'].map(tab => (
                      <button
                        key={tab}
                        className={`px-4 py-2 ${activeTab === tab ? 'border-b-2 border-blue-600 font-medium' : 'text-gray-600 hover:text-gray-800'}`}
                        onClick={() => setActiveTab(tab)}
                        aria-label={`Chuyển sang tab ${tab}`}
                      >
                        {tab === 'prices' ? 'Cài Đặt Giá' :
                         tab === 'inventory' ? 'Nhập Kho' :
                         tab === 'productPrices' ? 'Giá Sản Phẩm' :
                         tab === 'transactions' ? 'Lịch Sử Giao Dịch' : 'Phân Tích'}
                      </button>
                    ))}
                  </div>

                  {activeTab === 'prices' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">Cài Đặt Giá</h3>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium" htmlFor="first-hour">Giá giờ đầu (VND):</label>
                          <input
                            id="first-hour"
                            type="number"
                            value={prices.firstHour}
                            onChange={(e) => setPrices({ ...prices, firstHour: parseInt(e.target.value) || 0 })}
                            className="border p-2 w-full rounded"
                            aria-label="Giá giờ đầu"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium" htmlFor="extra-hour">Giá giờ tiếp theo (VND):</label>
                          <input
                            id="extra-hour"
                            type="number"
                            value={prices.extraHour}
                            onChange={(e) => setPrices({ ...prices, extraHour: parseInt(e.target.value) || 0 })}
                            className="border p-2 w-full rounded"
                            aria-label="Giá giờ tiếp theo"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium" htmlFor="overnight">Giá qua đêm (VND):</label>
                          <input
                            id="overnight"
                            type="number"
                            value={prices.overnight}
                            onChange={(e) => setPrices({ ...prices, overnight: parseInt(e.target.value) || 0 })}
                            className="border p-2 w-full rounded"
                            aria-label="Giá qua đêm"
                          />
                        </div>
                        <button
                          onClick={handlePriceUpdate}
                          className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                          disabled={loading}
                          aria-label="Cập nhật giá"
                        >
                          Cập nhật giá
                        </button>
                      </div>
                    </div>
                  )}

                  {activeTab === 'inventory' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">Nhập Kho</h3>
                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-1" htmlFor="excel-import">Nhập bằng Excel:</label>
                        <input
                          id="excel-import"
                          type="file"
                          accept=".xlsx"
                          onChange={handleExcelImport}
                          className="border p-2 w-full rounded"
                          aria-label="Nhập kho bằng Excel"
                        />
                        <p className="text-sm text-gray-500 mt-1">
                          File Excel cần cột: Tên SP, Số lượng, Giá nhập.
                        </p>
                      </div>
                      <div className="mb-4">
                        <h4 className="text-md font-medium mb-2">Nhập thủ công:</h4>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium" htmlFor="manual-name">Tên sản phẩm:</label>
                            <input
                              id="manual-name"
                              type="text"
                              value={manualInventory.name}
                              onChange={(e) => setManualInventory({ ...manualInventory, name: e.target.value })}
                              className="border p-2 w-full rounded"
                              required
                              aria-label="Tên sản phẩm thủ công"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium" htmlFor="manual-quantity">Số lượng:</label>
                            <input
                              id="manual-quantity"
                              type="number"
                              value={manualInventory.quantity}
                              onChange={(e) => setManualInventory({ ...manualInventory, quantity: parseInt(e.target.value) || 0 })}
                              className="border p-2 w-full rounded"
                              min="0"
                              required
                              aria-label="Số lượng thủ công"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium" htmlFor="manual-purchasePrice">Giá nhập (VND):</label>
                            <input
                              id="manual-purchasePrice"
                              type="number"
                              value={manualInventory.purchasePrice}
                              onChange={(e) => setManualInventory({ ...manualInventory, purchasePrice: parseInt(e.target.value) || 0 })}
                              className="border p-2 w-full rounded"
                              min="0"
                              required
                              aria-label="Giá nhập thủ công"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium" htmlFor="manual-salePrice">Giá bán (VND, tùy chọn):</label>
                            <input
                              id="manual-salePrice"
                              type="number"
                              value={manualInventory.salePrice}
                              onChange={(e) => setManualInventory({ ...manualInventory, salePrice: parseInt(e.target.value) || 0 })}
                              className="border p-2 w-full rounded"
                              min="0"
                              aria-label="Giá bán thủ công"
                            />
                          </div>
                          <button
                            onClick={handleManualInventory}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            disabled={loading}
                            aria-label="Thêm sản phẩm thủ công"
                          >
                            Thêm sản phẩm
                          </button>
                        </div>
                      </div>
                      <div>
                        <h4 className="text-md font-medium mb-2">Nhập hàng loạt:</h4>
                        {bulkInventory.map((item, index) => (
                          <div key={index} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 mb-2">
                            <input
                              type="text"
                              placeholder="Tên sản phẩm"
                              value={item.name}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].name = e.target.value;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                              aria-label={`Tên sản phẩm hàng loạt ${index + 1}`}
                            />
                            <input
                              type="number"
                              placeholder="Số lượng"
                              value={item.quantity}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].quantity = parseInt(e.target.value) || 0;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                              min="0"
                              aria-label={`Số lượng hàng loạt ${index + 1}`}
                            />
                            <input
                              type="number"
                              placeholder="Giá nhập"
                              value={item.purchasePrice}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].purchasePrice = parseInt(e.target.value) || 0;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                              min="0"
                              aria-label={`Giá nhập hàng loạt ${index + 1}`}
                            />
                            <input
                              type="number"
                              placeholder="Giá bán"
                              value={item.salePrice}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].salePrice = parseInt(e.target.value) || 0;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                              min="0"
                              aria-label={`Giá bán hàng loạt ${index + 1}`}
                            />
                          </div>
                        ))}
                        <div className="flex space-x-2 mt-2">
                          <button
                            onClick={() => setBulkInventory([...bulkInventory, { name: '', quantity: 0, purchasePrice: 0, salePrice: 0 }])}
                            className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                            aria-label="Thêm sản phẩm hàng loạt"
                          >
                            Thêm
                          </button>
                          <button
                            onClick={handleBulkInventory}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            disabled={loading}
                            aria-label="Nhập kho hàng loạt"
                          >
                            Nhập kho
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {activeTab === 'productPrices' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">Cập Nhật Giá Sản Phẩm</h3>
                      <div className="space-y-4">
                        {inventory.map(item => (
                          <div key={item._id} className="flex items-center space-x-2">
                            <span className="flex-grow">{item.name}</span>
                            <input
                              type="number"
                              placeholder="Giá bán"
                              value={productPrices[item._id] || item.salePrice || ''}
                              onChange={(e) => setProductPrices({ ...productPrices, [item._id]: e.target.value })}
                              className="border p-2 w-32 rounded"
                              min="0"
                              aria-label={`Giá bán ${item.name}`}
                            />
                          </div>
                        ))}
                        <button
                          onClick={handleProductPriceUpdate}
                          className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                          disabled={loading || !Object.keys(productPrices).length}
                          aria-label="Cập nhật giá sản phẩm"
                        >
                          Cập nhật giá
                        </button>
                      </div>
                    </div>
                  )}

                  {activeTab === 'transactions' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">Lịch Sử Giao Dịch</h3>
                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-1">Phòng:</label>
                        <Select
                          options={rooms.map(r => ({ value: r._id, label: `Phòng ${r.number}` }))}
                          value={filter.room}
                          onChange={(selected) => setFilter({ ...filter, room: selected })}
                          className="w-full"
                          placeholder="Chọn phòng"
                          isClearable
                        />
                      </div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-1">Loại nghỉ:</label>
                        <Select
                          options={[
                            { value: 'hourly', label: 'Nghỉ giờ' },
                            { value: 'overnight', label: 'Qua đêm' },
                          ]}
                          value={filter.type}
                          onChange={(selected) => setFilter({ ...filter, type: selected })}
                          className="w-full"
                          placeholder="Chọn loại nghỉ"
                          isClearable
                        />
                      </div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-1">Khoảng thời gian:</label>
                        <DatePicker
                          selectsRange
                          startDate={dateRange[0]}
                          endDate={dateRange[1]}
                          onChange={(update) => setDateRange(update)}
                          className="border p-2 w-full rounded"
                          dateFormat="dd/MM/yyyy"
                          placeholderText="Chọn khoảng thời gian"
                        />
                      </div>
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="border p-2 text-left">Phòng</th>
                            <th className="border p-2 text-left">Thời gian vào</th>
                            <th className="border p-2 text-left">Thời gian ra</th>
                            <th className="border p-2 text-left">Tổng tiền</th>
                            <th className="border p-2 text-left">Loại</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredTransactions.map(t => {
                            const room = rooms.find(r => r._id === t.roomId);
                            return (
                              <tr key={t._id} className="border-b">
                                <td className="border p-2">{room?.number || 'N/A'}</td>
                                <td className="border p-2">{new Date(t.checkInTime).toLocaleString('vi-VN')}</td>
                                <td className="border p-2">{new Date(t.checkOutTime).toLocaleString('vi-VN')}</td>
                                <td className="border p-2">{t.total.toLocaleString('vi-VN')} VND</td>
                                <td className="border p-2">{t.type === 'hourly' ? 'Nghỉ giờ' : 'Qua đêm'}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}

                  {activeTab === 'analytics' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">Phân tích</h3>
                      <div className="mb-4">
                        <h4 className="text-md font-medium mb-2">Biểu đồ doanh thu</h4>
                        <canvas id="revenueChart" className="w-full h-64"></canvas>
                      </div>
                      <div className="space-y-4">
                        <div>
                          <h4 className="text-sm font-medium">Phòng sử dụng nhiều nhất:</h4>
                          <p>
                            {analytics.topRoom
                              ? `Phòng ${rooms.find(r => r._id === analytics.topRoom.id)?.number || 'Không xác định'} (${analytics.topRoom.count} lượt)`
                              : 'Chưa có dữ liệu'}
                          </p>
                        </div>
                        <div>
                          <h4 className="text-sm font-medium">Sản phẩm bán chạy nhất:</h4>
                          <p>
                            {analytics.topItem
                              ? `${inventory.find(i => i._id === analytics.topItem.id)?.name || 'Không xác định'} (${analytics.topItem.count} lượt)`
                              : 'Chưa có dữ liệu'}
                          </p>
                        </div>
                        <div>
                          <h4 className="text-sm font-medium">Giờ cao điểm:</h4>
                          <p>{analytics.peakHour !== null ? `${analytics.peakHour}:00 - ${analytics.peakHour + 1}:00` : 'Chưa có dữ liệu'}</p>
                        </div>
                      </div>
                    </div>
                  )}
                </section>
              )}
            </main>
          </div>
        </Suspense>
      );
    });

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
