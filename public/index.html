<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n L√Ω Nh√† Ngh·ªâ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-date-picker@10.2.0/dist/DatePicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-select@5.7.0/dist/react-select.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-draggable@4.4.5/build/web/react-draggable.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/react-date-picker@10.2.0/dist/DatePicker.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/react-select@5.7.0/dist/react-select.min.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, lazy, Suspense } = React;

    // Lazy-load components
    const ToastContainer = lazy(() => import('./ToastContainer'));
    const InvoicePopup = lazy(() => import('./InvoicePopup'));

    const ToastContainer = ({ toasts, removeToast }) => {
      return (
        <div className="fixed bottom-4 right-4 space-y-2 z-50">
          {toasts.slice(-3).map(toast => (
            <div
              key={toast.id}
              className={`p-4 rounded-lg shadow-lg text-white flex items-center space-x-2 animate-fade-in
                ${toast.type === 'error' ? 'bg-red-500' : toast.type === 'warning' ? 'bg-yellow-500' : toast.type === 'info' ? 'bg-blue-500' : 'bg-green-500'}`}
            >
              <span>{toast.message}</span>
              {toast.action && (
                <button
                  onClick={() => toast.action.callback()}
                  className="underline hover:text-gray-200"
                >
                  {toast.action.label}
                </button>
              )}
              <button
                onClick={() => removeToast(toast.id)}
                className="text-white hover:text-gray-200"
              >
                ‚úï
              </button>
            </div>
          ))}
        </div>
      );
    };

    const InvoicePopup = ({ invoice, onClose }) => {
      const { jsPDF } = window.jspdf;
      const formatHours = (hours) => {
        const totalMinutes = Math.round(hours * 60);
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        return `${h} gi·ªù ${m} ph√∫t`;
      };

      const handlePrint = () => {
        window.print();
      };

      const handleExportPDF = () => {
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text(`H√≥a ƒê∆°n Ph√≤ng ${invoice.roomNumber}`, 10, 10);
        doc.setFontSize(12);
        doc.text(`Th·ªùi gian v√†o: ${new Date(invoice.checkInTime).toLocaleString('vi-VN')}`, 10, 20);
        doc.text(`Th·ªùi gian ra: ${new Date(invoice.checkOutTime).toLocaleString('vi-VN')}`, 10, 30);
        doc.text(`S·ªë gi·ªù s·ª≠ d·ª•ng: ${formatHours(invoice.hoursUsed)}`, 10, 40);
        doc.text(`S·∫£n ph·∫©m: ${invoice.items.join(', ') || 'Kh√¥ng c√≥'}`, 10, 50);
        doc.text(`Ph·ª• thu: ${invoice.surcharge.amount.toLocaleString('vi-VN')} VND (${invoice.surcharge.note || 'Kh√¥ng'})`, 10, 60);
        doc.text(`T·ªïng ti·ªÅn: ${invoice.total.toLocaleString('vi-VN')} VND`, 10, 70);
        doc.save(`hoa_don_phong_${invoice.roomNumber}.pdf`);
      };

      return (
        <Draggable>
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fade-in">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full print:bg-white print:shadow-none">
              <h3 className="text-xl font-semibold mb-4 print:text-center">H√≥a ƒê∆°n Ph√≤ng {invoice.roomNumber}</h3>
              <table className="w-full text-left border-collapse print:border print:border-gray-300">
                <tbody>
                  <tr className="border-b print:border-gray-300">
                    <td className="py-2 font-medium">Th·ªùi gian v√†o:</td>
                    <td className="py-2">{new Date(invoice.checkInTime).toLocaleString('vi-VN')}</td>
                  </tr>
                  <tr className="border-b print:border-gray-300">
                    <td className="py-2 font-medium">Th·ªùi gian ra:</td>
                    <td className="py-2">{new Date(invoice.checkOutTime).toLocaleString('vi-VN')}</td>
                  </tr>
                  <tr className="border-b print:border-gray-300">
                    <td className="py-2 font-medium">S·ªë gi·ªù s·ª≠ d·ª•ng:</td>
                    <td className="py-2">{formatHours(invoice.hoursUsed)}</td>
                  </tr>
                  <tr className="border-b print:border-gray-300">
                    <td className="py-2 font-medium">S·∫£n ph·∫©m:</td>
                    <td className="py-2">{invoice.items.join(', ') || 'Kh√¥ng c√≥'}</td>
                  </tr>
                  <tr className="border-b print:border-gray-300">
                    <td className="py-2 font-medium">Ph·ª• thu:</td>
                    <td className="py-2">{invoice.surcharge.amount.toLocaleString('vi-VN')} VND ({invoice.surcharge.note || 'Kh√¥ng'})</td>
                  </tr>
                  <tr className="border-b print:border-gray-300">
                    <td className="py-2 font-medium">T·ªïng ti·ªÅn:</td>
                    <td className="py-2 font-bold">{invoice.total.toLocaleString('vi-VN')} VND</td>
                  </tr>
                </tbody>
              </table>
              <div className="flex justify-end mt-4 space-x-2 print:hidden">
                <button
                  onClick={handlePrint}
                  className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                  In
                </button>
                <button
                  onClick={handleExportPDF}
                  className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                >
                  Xu·∫•t PDF
                </button>
                <button
                  onClick={onClose}
                  className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                >
                  ƒê√≥ng
                </button>
              </div>
            </div>
          </div>
        </Draggable>
      );
    };

    const App = React.memo(() => {
      const [rooms, setRooms] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [selectedRoom, setSelectedRoom] = useState(null);
      const [pin, setPin] = useState('');
      const [isAdmin, setIsAdmin] = useState(false);
      const [prices, setPrices] = useState({ firstHour: 90000, extraHour: 20000, overnight: 200000 });
      const [report, setReport] = useState({ daily: 0, weekly: 0, monthly: 0 });
      const [checkInData, setCheckInData] = useState({
        items: [],
        surcharge: { amount: 0, note: '' },
        type: 'hourly',
        cccd: '',
        fullName: '',
      });
      const [loading, setLoading] = useState(false);
      const [activeTab, setActiveTab] = useState(localStorage.getItem('activeTab') || 'prices');
      const [manualInventory, setManualInventory] = useState({ name: '', quantity: 0, purchasePrice: 0, salePrice: 0 });
      const [productPrices, setProductPrices] = useState({});
      const [toasts, setToasts] = useState([]);
      const [invoice, setInvoice] = useState(null);
      const [transactions, setTransactions] = useState([]);
      const [dateRange, setDateRange] = useState([new Date(), new Date()]);
      const [filter, setFilter] = useState({ room: null, type: null });
      const [bulkInventory, setBulkInventory] = useState([{ name: '', quantity: 0, purchasePrice: 0, salePrice: 0 }]);
      const socket = useMemo(() => io(), []);

      useEffect(() => {
        fetchData();
        const interval = setInterval(() => setRooms(prev => [...prev]), 60000);
        socket.on('roomUpdate', (updatedRooms) => setRooms(updatedRooms));
        socket.on('inventoryUpdate', (updatedInventory) => setInventory(updatedInventory));
        return () => {
          clearInterval(interval);
          socket.disconnect();
        };
      }, []);

      useEffect(() => {
        localStorage.setItem('activeTab', activeTab);
      }, [activeTab]);

      const addToast = useCallback((message, type, action = null) => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type, action }]);
      }, []);

      const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(toast => toast.id !== id));
      }, []);

      const fetchData = useCallback(async () => {
        setLoading(true);
        try {
          const [roomsRes, inventoryRes, reportRes, transactionsRes] = await Promise.all([
            axios.get('/api/rooms'),
            axios.get('/api/inventory'),
            axios.get('/api/reports'),
            axios.get('/api/transactions'),
          ]);
          setRooms(roomsRes.data);
          setInventory(inventoryRes.data);
          setReport(reportRes.data);
          setTransactions(transactionsRes.data);
        } catch (error) {
          addToast('L·ªói khi l·∫•y d·ªØ li·ªáu: ' + error.message, 'error');
        } finally {
          setLoading(false);
        }
      }, []);

      const handleCheckIn = useCallback(async (roomId) => {
        setLoading(true);
        try {
          await axios.post('/api/checkin', {
            roomId,
            items: checkInData.items,
            checkInTime: new Date(),
            type: checkInData.type,
            cccd: checkInData.cccd,
            fullName: checkInData.fullName,
          });
          fetchData();
          setCheckInData({ items: [], surcharge: { amount: 0, note: '' }, type: 'hourly', cccd: '', fullName: '' });
          setSelectedRoom(null);
          addToast('Check-in th√†nh c√¥ng', 'success');
        } catch (error) {
          addToast('L·ªói khi check-in: ' + (error.response?.data?.error || error.message), 'error');
        } finally {
          setLoading(false);
        }
      }, [checkInData, fetchData]);

      const handleCheckOut = useCallback(async (roomId) => {
        setLoading(true);
        try {
          const response = await axios.post('/api/checkout', { roomId, surcharge: checkInData.surcharge });
          const { total, checkInTime, checkOutTime, hoursUsed, items } = response.data;
          const room = rooms.find(r => r._id === roomId);
          const itemDetails = await Promise.all(
            items.map(async (item) => {
              const inventoryItem = inventory.find(i => i._id === item.itemId);
              return `${inventoryItem.name} x${item.quantity} (${(inventoryItem.salePrice * item.quantity).toLocaleString('vi-VN')} VND)`;
            })
          );
          setInvoice({
            roomNumber: room.number,
            checkInTime,
            checkOutTime,
            hoursUsed,
            items: itemDetails,
            surcharge: checkInData.surcharge,
            total,
          });
          fetchData();
          setCheckInData({ items: [], surcharge: { amount: 0, note: '' }, type: 'hourly', cccd: '', fullName: '' });
          setSelectedRoom(null);
          addToast('Check-out th√†nh c√¥ng', 'success', {
            label: 'Ho√†n t√°c',
            callback: async () => {
              await axios.post('/api/undo-checkout', { roomId });
              fetchData();
              addToast('Ho√†n t√°c check-out th√†nh c√¥ng', 'success');
            },
          });
        } catch (error) {
          addToast('L·ªói khi check-out: ' + (error.response?.data?.error || error.message), 'error');
        } finally {
          setLoading(false);
        }
      }, [checkInData, rooms, inventory, fetchData]);

      const handleCleanRoom = useCallback(async (roomId) => {
        if (window.confirm('X√°c nh·∫≠n ph√≤ng ƒë√£ ƒë∆∞·ª£c d·ªçn s·∫°ch?')) {
          setLoading(true);
          try {
            await axios.post('/api/clean-room', { roomId });
            fetchData();
            setSelectedRoom(null);
            addToast('Ph√≤ng ƒë√£ ƒë∆∞·ª£c d·ªçn s·∫°ch', 'success');
          } catch (error) {
            addToast('L·ªói khi d·ªçn ph√≤ng: ' + (error.response?.data?.error || error.message), 'error');
          } finally {
            setLoading(false);
          }
        }
      }, [fetchData]);

      const handleAdminLogin = useCallback(() => {
        if (pin === '123456') {
          setIsAdmin(true);
          setPin('');
          addToast('ƒêƒÉng nh·∫≠p admin th√†nh c√¥ng', 'success');
        } else {
          addToast('M√£ PIN kh√¥ng ƒë√∫ng', 'error');
        }
      }, [pin]);

      const handlePriceUpdate = useCallback(async () => {
        setLoading(true);
        try {
          await axios.post('/api/prices', prices);
          addToast('C·∫≠p nh·∫≠t gi√° th√†nh c√¥ng', 'success');
        } catch (error) {
          addToast('L·ªói khi c·∫≠p nh·∫≠t gi√°: ' + (error.response?.data?.error || error.message), 'error');
        } finally {
          setLoading(false);
        }
      }, [prices]);

      const handleExcelImport = useCallback(async (event) => {
        setLoading(true);
        try {
          const file = event.target.files[0];
          if (!file) throw new Error('Vui l√≤ng ch·ªçn file Excel');
          const formData = new FormData();
          formData.append('file', file);
          await axios.post('/api/inventory/import', formData);
          fetchData();
          addToast('Nh·∫≠p kho th√†nh c√¥ng', 'success');
        } catch (error) {
          addToast('L·ªói khi nh·∫≠p kho: ' + (error.response?.data?.error || error.message), 'error');
        } finally {
          setLoading(false);
        }
      }, [fetchData]);

      const handleManualInventory = useCallback(async () => {
        if (!manualInventory.name || manualInventory.quantity < 0 || manualInventory.purchasePrice < 0) {
          addToast('T√™n, s·ªë l∆∞·ª£ng v√† gi√° nh·∫≠p l√† b·∫Øt bu·ªôc, kh√¥ng ƒë∆∞·ª£c √¢m', 'warning');
          return;
        }
        setLoading(true);
        try {
          await axios.post('/api/inventory', {
            id: manualInventory.id || null,
            name: manualInventory.name,
            quantity: manualInventory.quantity,
            purchasePrice: manualInventory.purchasePrice,
            salePrice: manualInventory.salePrice || 0,
          });
          fetchData();
          setManualInventory({ name: '', quantity: '', purchasePrice: 0, salePrice: 0 });
          addToast('Th√™m s·∫£n ph·∫©m th√†nh c√¥ng', 'success');
        } catch (error) {
          addToast('L·ªói khi th√™m s·∫£n ph·∫©m: ' + (error.response?.data?.error || error.message), 'error');
        } finally {
          setLoading(false);
        }
      }, [manualInventory, fetchData]);

      const handleBulkInventory = useCallback(async () => {
        const validItems = bulkInventory.filter(item => item.name && item.quantity >= 0 && item.purchasePrice >= 0);
        if (!validItems.length) {
          addToast('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m h·ª£p l·ªá', 'warning');
          return;
        }
        setLoading(true);
        try {
          await axios.post('/api/inventory/bulk', validItems);
          fetchData();
          setBulkInventory([{ name: '', quantity: 1, purchasePrice: 0, salePrice: 0 }]);
          addToast('Nh·∫≠p kho h√†ng lo·∫°t th√†nh c√¥ng', 'success');
        } catch (error) {
          addToast('L·ªói khi nh·∫≠p kho: ' + (error.response?.data?.error || error.message), 'error');
        } finally {
          setLoading(false);
        }
      }, [bulkInventory, fetchData]);

      const handleProductPriceUpdate = useCallback(async () => {
        setLoading(true);
        try {
          await Promise.all(
            Object.entries(productPrices).map(([id, salePrice]) =>
              axios.post('/api/inventory/price', { id, salePrice: parseInt(salePrice) || 0 })
            );
          );
          setProductPrices({});
          fetchData();
          addToast('C·∫≠p nh·∫≠t gi√° s·∫£n ph·∫©m th√†nh c√¥ng', 'success');
        } catch (error) {
          addToast('L·ªói khi c·∫≠p nh·∫≠t gi√° s·∫£n ph·∫©m: ' + (error.response?.data?.error || error.message), 'error');
        } finally {
          setLoading(false);
        }
      }, [productPrices, fetchData]);

      const getRoomColor = useCallback((status) => ({
        vacant: 'bg-green-100 text-green-800',
        occupied: 'bg-blue-100 text-blue-800',
        dirty: 'bg-yellow-100 text-yellow-800',
      }[status] || 'bg-gray-100 text-gray-800'), []);

      const getRoomIcon = useCallback((status) => ({
        vacant: '‚úîÔ∏è',
        occupied: 'üë§',
        dirty: 'üßπ',
      }[status] || '‚ùì'), []);

      const getCurrentHours = useCallback((checkInTime) => {
        if (!checkInTime) return '0 gi·ªù 0 ph√∫t';
        const totalMinutes = Math.round((new Date() - new Date(checkInTime)) / (1000 * 60));
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours} gi·ªù ${minutes} ph√∫t`;
      }, []);

      const filteredTransactions = useMemo(() => {
        return transactions.filter((t) => {
          const roomMatch = !filter.room || t.roomId === filter.room?.value;
          const typeMatch = !filter.type || t.type === filter.type?.value;
          const dateMatch = !dateRange[0] || !dateRange[1] ||
            (new Date(t.checkOutTime) >= dateRange[0] && new Date(t.checkOutTime) <= dateRange[1]);
          return roomMatch && typeMatch && dateMatch;
        });
      }, [transactions, filter, dateRange]);

      const analytics = useMemo(() => {
        const roomUsage = {};
        const itemSales = {};
        const hourlyRevenue = Array(24).fill(0);

        transactions.forEach(t => {
          roomUsage[t.roomId] = (roomUsage[t.roomId] || 0) + 1;
          t.items.forEach(item => {
            itemSales[item.itemId] = (itemSales[item.itemId] || 0) + item.quantity;
          });
          const hour = new Date(t.checkInTime).getHours();
          hourlyRevenue[hour] += t.total;
        });

        const topRoom = Object.entries(roomUsage).sort((a, b) => b[1] - a[1])[0];
        const topItem = Object.entries(itemSales).sort((a, b) => b[1] - a[1])[0];
        const peakHour = hourlyRevenue.indexOf(Math.max(...hourlyRevenue));

        return {
          topRoom: topRoom ? { id: topRoom[0], count: topRoom[1] } : null,
          topItem: topItem ? { id: topItem[0], count: topItem[1] } : null,
          peakHour,
        };
      }, [transactions]);

      const chartData = useMemo(() => ({
        labels: ['Ng√†y', 'Tu·∫ßn', 'Th√°ng'],
        datasets: [{
          label: [report.daily, report.weekly, report.monthly],
          data: [report.daily, report.weekly, report.monthly],
          backgroundColor: ['#2563eb', '#4a90e2', '#90cdf4'],
        }],
      ],
      [report]);

      return (
        <Suspense fallback={<div className="text-center p-4">ƒêang t·∫£i...</div>}>
          <div className="min-h-screen bg-white">
            <ToastContainer toasts={toasts} removeToast={removeToast} />
            {invoice && <InvoicePopup invoice={invoice} onClose={() => setInvoice(null)} />}

            {/* Header */}
            <header className="bg-blue-600 text-white p-4 shadow-lg">
              <div className="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <h1 className="text-2xl md:text-3xl font-bold mb-2 sm:mb-0">Qu·∫£n L√Ω Nh√† Ngh·ªâ</h1>
                {!isAdmin ? (
                  <div className="flex items-center space-x-2">
                    <input
                      type="password"
                      placeholder="Nh·∫≠p m√£ PIN Admin"
                      value={pin}
                      onChange={(e) => setPin(e.target.value)}
                      className="border p-2 rounded text-gray-800 w-full sm:w-auto"
                    />
                    <button
                      onClick={handleAdminLogin}
                      className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                    >
                      ƒêƒÉng nh·∫≠p
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => setIsAdmin(false)}
                    className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                  >
                    ƒêƒÉng xu·∫•t
                  </button>
                )}
              </div>
            </header>

            {/* Main Content */}
            <main className="container mx-auto p-4 md:p-6">
              {loading && (
                <div className="text-center text-blue-600 mb-4">
                  <svg className="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" />
                  </svg>
                  ƒêang t·∫£i...
                </div>
              )}

              {/* Danh s√°ch ph√≤ng */}
              <section className="mb-8 bg-white p-6 rounded-lg shadow-md">
                <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
                  <h2 className="text-xl md:text-2xl font-semibold mb-2 sm:mb-0">Tr·∫°ng Th√°i Ph√≤ng</h2>
                  <button
                    onClick={fetchData}
                    className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                  >
                    L√†m m·ªõi
                  </button>
                </div>
                {['2', '3', '4'].map(floor => (
                  <div key={floor} className="mb-6">
                    <h3 className="text-lg md:text-xl font-medium mb-2">T·∫ßng {floor}</h3>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                      {rooms.filter(room => room.floor === floor).map(room => (
                        <div
                          key={room._id}
                          className={`relative p-4 rounded-lg ${getRoomColor(room.status)} text-center cursor-pointer shadow-md hover:shadow-lg transition-shadow group`}
                          onClick={() => setSelectedRoom(room)}
                        >
                          <div className="flex items-center justify-center space-x-2">
                            <span>{getRoomIcon(room.status)}</span>
                            <div>Ph√≤ng {room.number}</div>
                          </div>
                          {room.status === 'occupied' && (
                            <div className="text-sm mt-2">
                              {room.type === 'overnight' ? 'Qua ƒë√™m' : 'Ngh·ªâ gi·ªù'}
                              <br />
                              V√†o: {new Date(room.checkInTime).toLocaleTimeString('vi-VN')}
                              <br />
                              ƒê√£ d√πng: {getCurrentHours(room.checkInTime)}
                            </div>
                          )}
                          <div className="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded p-2 -top-10 left-1/2 transform -translate-x-1/2 z-10">
                            {room.status === 'occupied'
                              ? `V√†o: ${new Date(room.checkInTime).toLocaleString('vi-VN')}, Lo·∫°i: ${room.type === 'overnight' ? 'Qua ƒë√™m' : 'Ngh·ªâ gi·ªù'}`
                              : `Tr·∫°ng th√°i: ${room.status === 'vacant' ? 'Tr·ªëng' : 'C·∫ßn d·ªçn'}`}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </section>

              {/* Modal Check-in/Check-out */}
              {selectedRoom && (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                  <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                    <h3 className="text-xl font-semibold mb-4">
                      {selectedRoom.status === 'dirty' ? `X√°c Nh·∫≠n D·ªçn Ph√≤ng ${selectedRoom.number}` : `Qu·∫£n L√Ω Ph√≤ng ${selectedRoom.number}`}
                    </h3>
                    {selectedRoom.status === 'dirty' ? (
                      <div>
                        <p className="mb-4">Ph√≤ng c·∫ßn d·ªçn d·∫πp. X√°c nh·∫≠n chuy·ªÉn sang tr·∫°ng th√°i tr·ªëng?</p>
                        <div className="flex justify-end space-x-2">
                          <button
                            onClick={() => handleCleanRoom(selectedRoom._id)}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            disabled={loading}
                          >
                            X√°c nh·∫≠n
                          </button>
                          <button
                            onClick={() => setSelectedRoom(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                          >
                            ƒê√≥ng
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div>
                        {selectedRoom.status === 'vacant' && (
                          <>
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1">Lo·∫°i ngh·ªâ:</label>
                              <select
                                value={checkInData.type}
                                onChange={(e) => setCheckInData({ ...checkInData, type: e.target.value })}
                                className="border p-2 w-full rounded"
                              >
                                <option value="hourly">Ngh·ªâ gi·ªù</option>
                                <option value="overnight">Qua ƒë√™m</option>
                              </select>
                            </div>
                            {checkInData.type === 'overnight' && (
                              <>
                                <div className="mb-4">
                                  <label className="block text-sm font-medium mb-1">CCCD:</label>
                                  <input
                                    type="text"
                                    placeholder="S·ªë CCCD"
                                    value={checkInData.cccd}
                                    onChange={(e) => setCheckInData({ ...checkInData, cccd: e.target.value })}
                                    className="border p-2 w-full rounded"
                                  />
                                </div>
                                <div className="mb-4">
                                  <label className="block text-sm font-medium mb-1">H·ªç T√™n:</label>
                                  <input
                                    type="text"
                                    placeholder="H·ªç v√† T√™n"
                                    value={checkInData.fullName}
                                    onChange={(e) => setCheckInData({ ...checkInData, fullName: e.target.value })}
                                    className="border p-2 w-full rounded"
                                  />
                                </div>
                              </>
                            )}
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1">Ch·ªçn s·∫£n ph·∫©m:</label>
                              {inventory.map(item => (
                                <div key={item._id} className="flex items-center mb-2">
                                  <input
                                    type="number"
                                    min="0"
                                    max={item.quantity}
                                    placeholder="S·ªë l∆∞·ª£ng"
                                    onChange={(e) => {
                                      const quantity = parseInt(e.target.value) || 0;
                                      const items = checkInData.items.filter(i => i.itemId !== item._id);
                                      if (quantity > 0) items.push({ itemId: item._id, quantity });
                                      setCheckInData({ ...checkInData, items });
                                    }}
                                    className="border p-2 w-20 mr-2 rounded"
                                  />
                                  <span>{item.name} (T·ªìn: {item.quantity})</span>
                                </div>
                              ))}
                            </div>
                          </>
                        )}
                        {selectedRoom.status === 'occupied' && (
                          <>
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1">Ph·ª• thu (VND):</label>
                              <input
                                type="number"
                                placeholder="S·ªë ti·ªÅn ph·ª• thu"
                                value={checkInData.surcharge.amount}
                                onChange={(e) => setCheckInData({
                                  ...checkInData,
                                  surcharge: { ...checkInData.surcharge, amount: parseInt(e.target.value) || 0 }
                                })}
                                className="border p-2 w-full rounded"
                              />
                            </div>
                            <div className="mb-4">
                              <label className="block text-sm font-medium mb-1">Ghi ch√∫ ph·ª• thu:</label>
                              <input
                                type="text"
                                placeholder="Ghi ch√∫"
                                value={checkInData.surcharge.note}
                                onChange={(e) => setCheckInData({
                                  ...checkInData,
                                  surcharge: { ...checkInData.surcharge, note: e.target.value }
                                })}
                                className="border p-2 w-full rounded"
                              />
                            </div>
                          </>
                        )}
                        <div className="flex justify-end space-x-2">
                          {selectedRoom.status === 'vacant' && (
                            <button
                              onClick={() => handleCheckIn(selectedRoom._id)}
                              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                              disabled={loading || (checkInData.type === 'overnight' && (!checkInData.cccd || !checkInData.fullName))}
                            >
                              Check-In
                            </button>
                          )}
                          {selectedRoom.status === 'occupied' && (
                            <button
                              onClick={() => handleCheckOut(selectedRoom._id)}
                              className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                              disabled={loading}
                            >
                              Check-Out
                            </button>
                          )}
                          <button
                            onClick={() => setSelectedRoom(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                          >
                            ƒê√≥ng
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Admin Panel */}
              {isAdmin && (
                <section className="mb-8 bg-white p-6 rounded-lg shadow-md">
                  <h2 className="text-xl md:text-2xl font-semibold mb-4">B·∫£ng Qu·∫£n Tr·ªã</h2>
                  <div className="flex flex-wrap border-b mb-4">
                    {['prices', 'inventory', 'productPrices', 'transactions', 'analytics'].map(tab => (
                      <button
                        key={tab}
                        className={`px-4 py-2 ${activeTab === tab ? 'border-b-2 border-blue-600' : ''}`}
                        onClick={() => setActiveTab(tab)}
                      >
                        {tab === 'prices' ? 'C√†i ƒê·∫∑t Gi√°' :
                         tab === 'inventory' ? 'Nh·∫≠p Kho' :
                         tab === 'productPrices' ? 'Gi√° S·∫£n Ph·∫©m' :
                         tab === 'transactions' ? 'L·ªãch S·ª≠ Giao D·ªãch' : 'Ph√¢n T√≠ch'}
                      </button>
                    ))}
                  </div>

                  {activeTab === 'prices' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">C√†i ƒê·∫∑t Gi√°</h3>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium">Gi√° gi·ªù ƒë·∫ßu (VND):</label>
                          <input
                            type="number"
                            value={prices.firstHour}
                            onChange={(e) => setPrices({ ...prices, firstHour: parseInt(e.target.value) || 0 })}
                            className="border p-2 w-full rounded"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium">Gi√° gi·ªù ti·∫øp theo (VND):</label>
                          <input
                            type="number"
                            value={prices.extraHour}
                            onChange={(e) => setPrices({ ...prices, extraHour: parseInt(e.target.value) || 0 })}
                            className="border p-2 w-full rounded"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium">Gi√° qua ƒë√™m (VND):</label>
                          <input
                            type="number"
                            value={prices.overnight}
                            onChange={(e) => setPrices({ ...prices, overnight: parseInt(e.target.value) || 0 })}
                            className="border p-2 w-full rounded"
                          />
                        </div>
                        <button
                          onClick={handlePriceUpdate}
                          className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                          disabled={loading}
                        >
                          C·∫≠p nh·∫≠t gi√°
                        </button>
                      </div>
                    </div>
                  )}

                  {activeTab === 'inventory' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">Nh·∫≠p Kho</h3>
                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-1">Nh·∫≠p b·∫±ng Excel:</label>
                        <input
                          type="file"
                          accept=".xlsx"
                          onChange={handleExcelImport}
                          className="border p-2 w-full rounded"
                        />
                        <p className="text-sm text-gray-500 mt-1">
                          File Excel c·∫ßn c·ªôt: T√™n SP, S·ªë l∆∞·ª£ng, Gi√° nh·∫≠p.
                        </p>
                      </div>
                      <div className="mb-4">
                        <h4 className="text-md font-medium mb-2">Nh·∫≠p th·ªß c√¥ng:</h4>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium">T√™n s·∫£n ph·∫©m:</label>
                            <input
                              type="text"
                              value={manualInventory.name}
                              onChange={(e) => setManualInventory({ ...manualInventory, name: e.target.value })}
                              className="border p-2 w-full rounded"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium">S·ªë l∆∞·ª£ng:</label>
                            <input
                              type="number"
                              value={manualInventory.quantity}
                              onChange={(e) => setManualInventory({ ...manualInventory, quantity: parseInt(e.target.value) || 0 })}
                              className="border p-2 w-full rounded"
                              min="0"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium">Gi√° nh·∫≠p (VND):</label>
                            <input
                              type="number"
                              value={manualInventory.purchasePrice}
                              onChange={(e) => setManualInventory({ ...manualInventory, purchasePrice: parseInt(e.target.value) || 0 })}
                              className="border p-2 w-full rounded"
                              min="0"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium">Gi√° b√°n (VND, t√πy ch·ªçn):</label>
                            <input
                              type="number"
                              value={manualInventory.salePrice}
                              onChange={(e) => setManualInventory({ ...manualInventory, salePrice: parseInt(e.target.value) || 0 })}
                              className="border p-2 w-full rounded"
                              min="0"
                            />
                          </div>
                          <button
                            onClick={handleManualInventory}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            disabled={loading}
                          >
                            Th√™m s·∫£n ph·∫©m
                          </button>
                        </div>
                      </div>
                      <div>
                        <h4 className="text-md font-medium mb-2">Nh·∫≠p h√†ng lo·∫°t:</h4>
                        {bulkInventory.map((item, index) => (
                          <div key={index} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 mb-2">
                            <input
                              type="text"
                              placeholder="T√™n s·∫£n ph·∫©m"
                              value={item.name}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].name = e.target.value;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                            />
                            <input
                              type="number"
                              placeholder="S·ªë l∆∞·ª£ng"
                              value={item.quantity}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].quantity = parseInt(e.target.value) || 0;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                              min="0"
                            />
                            <input
                              type="number"
                              placeholder="Gi√° nh·∫≠p"
                              value={item.purchasePrice}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].purchasePrice = parseInt(e.target.value) || 0;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                              min="0"
                            />
                            <input
                              type="number"
                              placeholder="Gi√° b√°n"
                              value={item.salePrice}
                              onChange={(e) => {
                                const newItems = [...bulkInventory];
                                newItems[index].salePrice = parseInt(e.target.value) || 0;
                                setBulkInventory(newItems);
                              }}
                              className="border p-2 rounded"
                              min="0"
                            />
                          </div>
                        ))}
                        <div className="flex space-x-2">
                          <button
                            onClick={() => setBulkInventory([...bulkInventory, { name: '', quantity: 1, purchasePrice: 0, salePrice: 0 }])}
                            className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                          >
                            Th√™m d√≤ng
                          </button>
                          <button
                            onClick={handleBulkInventory}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            disabled={loading}
                          >
                            Nh·∫≠p kho
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {activeTab === 'productPrices' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">C√†i ƒê·∫∑t Gi√° S·∫£n Ph·∫©m</h3>
                      <div className="space-y-2">
                        {inventory.map(item => (
                          <div key={item._id} className="flex items-center p-2 bg-gray-50 rounded">
                            <span className="flex-1">{item.name} (T·ªìn: {item.quantity})</span>
                            {item.quantity < 10 && (
                              <span className="text-yellow-500 mr-2">‚ö† S·∫Øp h·∫øt h√†ng</span>
                            )}
                            <input
                              type="number"
                              placeholder="Gi√° b√°n (VND)"
                              value={productPrices[item._id] ?? item.salePrice ?? ''}
                              onChange={(e) => setProductPrices({
                                ...productPrices,
                                [item._id]: e.target.value
                              })}
                              className="border p-2 w-32 rounded"
                              min="0"
                            />
                            {!item.salePrice && <span className="text-red-500 ml-2">Ch∆∞a ƒë·∫∑t gi√°</span>}
                          </div>
                        ))}
                      </div>
                      <button
                        onClick={handleProductPriceUpdate}
                        className="bg-blue-500 text-white px-4 py-2 rounded mt-4 hover:bg-blue-600"
                        disabled={loading || Object.keys(productPrices).length === 0}
                      >
                        C·∫≠p nh·∫≠t gi√°
                      </button>
                    </div>
                  )}

                  {activeTab === 'transactions' && (
                    <div>
                      <h3 className="text-lg font-medium mb-2">L·ªãch S·ª≠ Giao D·ªãch</h3>
                      <div className="mb-4 flex flex-col sm:flex-row gap-4">
                        <div className="flex-1">
                          <label className="block text-sm font-medium mb-1">Kho·∫£ng th·ªùi gian:</label>
                          <DatePicker
                            selectsRange
                            startDate={dateRange[0]}
                            endDate={dateRange[1]}
                            onChange={setDateRange}
                            className="border p-2 w-full rounded"
                          />
                        </div>
                        <div className="flex-1">
                          <label className="block text-sm font-medium mb-1">Ph√≤ng:</label>
                          <Select
                            options={rooms.map(room => ({ value: room._id, label: `Ph√≤ng ${room.number}` }))}
                            value={filter.room}
                            onChange={(option) => setFilter({ ...filter, room: option })}
                            isClearable
                            className="w-full"
                          />
                        </div>
                        <div className="flex-1">
                          <label className="block text-sm font-medium mb-1">Lo·∫°i ngh·ªâ:</label>
                          <Select
                            options={[
                              { value: 'hourly', label: 'Ngh·ªâ gi·ªù' },
                              { value: 'overnight', label: 'Qua ƒë√™m' },
                            ]}
                            value={filter.type}
                            onChange={(option) => setFilter({ ...filter, type: option })}
                            isClearable
                            className="w-full"
                          />
                        </div>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                          <thead>
                            <tr className="bg-gray-100">
                              <th className="p-2">Ph√≤ng</th>
                              <th className="p-2">Th·ªùi gian v√†o</th>
                              <th className="p-2">Th·ªùi gian ra</th>
                              <th className="p-2">Lo·∫°i</th>
                              <th className="p-2">T·ªïng ti·ªÅn</th>
                            </tr>
                          </thead>
                          <tbody>
                            {filteredTransactions.map(tx => (
                              const room = rooms.find(r => r._id === tx.roomId);
                              return (
                                <tr key={tx._id} className="border-b">
                                  <td className="p-2">{room?.number || 'N/A'}</td>
                                  <td className="p-2">{new Date(tx.checkInTime).toLocaleString('vi-VN')}</td>
                                  <td className="p-2">{new Date(tx.checkOutTime).toLocaleString('vi-VN')}</td>
                                  <td className="p-2">{tx.type === 'hourly' ? 'Ngh·ªâ gi·ªù' : 'Qua ƒë√™m'}</td>
                                  <td className="p-2">{tx.total.toLocaleString('vi-VN')} VND</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                </div>
              )}

              {activeTab === 'analytics' && (
                <div>
                  <h3 className="text-lg font-medium mb-2">Ph√¢n t√≠ch</h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div className="bg-gray-100 p-4 rounded-lg">
                      <h4 className="font-medium">Ph√≤ng s·ª≠ d·ª•ng nhi·ªÅu nh·∫•t</h4>
                      <p>{analytics.topRoom ? `Ph√≤ng ${rooms.find(r => r._id === analytics.topRoom.id)?.number} (${analytics.topRoom.count} l∆∞·ª£t)` : 'Ch∆∞a c√≥ d·ªØ li·ªáu'}</p>
                    </div>
                    <div className="bg-gray-100 p-4 rounded-lg">
                      <h4 className="font-medium">S·∫£n ph·∫©m b√°n ch·∫°y</h4>
                      <p>{analytics.topItem ? `${inventory.find(i => i._id === analytics.topItem.id)?.name} (${analytics.topItem.count} ƒë∆°n v·ªã)` : 'Ch∆∞a c√≥ d·ªØ li·ªáu'}</p>
                    </div>
                    <div className="bg-gray-100 p-4 rounded-lg">
                      <h4 className="font-medium">Gi·ªù cao ƒëi·ªÉm</h4>
                      <p>{analytics.peakHour !== undefined ? `${analytics.peakHour}:00 - ${analytics.peakHour + 1}:00` : 'Ch∆∞a c√≥ d·ªØ li·ªáu'}</p>
                    </div>
                  </div>
                </div>
              )}
            </section>
          )}
          
          {/* B√°o c√°o */}
          <section className="mb-8 bg-white p-6 rounded-lg shadow-md">
            <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
              <h2 className="text-xl md:text-2xl font-semibold mb-2 sm:mb-0">B√°o C√°o Thu Chi</h2>
              <button
                onClick={fetchData}
                className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                L√†m m·ªõi
              </button>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
              <div className="bg-gray-100 p-4 rounded-lg shadow">
                <h3 className="text-lg font-medium">Doanh thu ng√†y</h3>
                <p className="text-2xl">{report.daily.toLocaleString('vi-VN')} VND</p>
              </div>
              <div className="bg-gray-100 p-4 rounded-lg shadow">
                <h3 className="text-lg font-medium">Doanh thu tu·∫ßn</h3>
                <p className="text-2xl">{report.weekly.toLocaleString('vi-VN')} VND</p>
              </div>
              <div className="bg-gray-100 p-4 rounded-lg shadow">
                <h3 className="text-lg font-medium">Doanh thu th√°ng</h3>
                <p className="text-2xl">{report.monthly.toLocaleString('vi-VN')} VND</p>
              </div>
            </div>
            <canvas id="myChart" className="max-w-full"></canvas>
            <script type="text/babel">
              useEffect(() => {
                const ctx = document.getElementById('myChart').getContext('2d');
                const chart = new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: ['Ng√†y', 'Tu·∫ßn', 'Th√°ng'],
                    datasets: [{
                      label: 'Doanh thu (VND)',
                      data: [{report.daily}, {report.weekly}, {report.monthly}],
                      backgroundColor: ['#2563eb', '#4a90e2', '#90cdf4'],
                    }],
                  },
                  options: {
                    responsive: true,
                    scales: {
                      y: { beginAtZero: true },
                    },
                  },
                });
                return () => chart.destroy();
              }, [report]);
            </script>
          </section>
        </main>
      </div>
    </Suspense>
  );
});

ReactDOM.render(<App />, document.getElementById('root'));
</script>
<style type="text/css">
@media print {
  body * {
    visibility: hidden;
  }
  .print-content, .print-content * {
    visibility: visible;
  }
  .print-content {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }
}
@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>
</body>
</html>
