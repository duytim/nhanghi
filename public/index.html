<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản Lý Nhà Nghỉ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [rooms, setRooms] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [selectedRoom, setSelectedRoom] = useState(null);
      const [pin, setPin] = useState('');
      const [isAdmin, setIsAdmin] = useState(false);
      const [prices, setPrices] = useState({ firstHour: 90000, extraHour: 20000, overnight: 200000 });
      const [report, setReport] = useState({ daily: 0, weekly: 0, monthly: 0 });
      const [checkInData, setCheckInData] = useState({ items: [], surcharge: { amount: 0, note: '' } });

      useEffect(() => {
        fetchRooms();
        fetchInventory();
        fetchReports();
      }, []);

      const fetchRooms = async () => {
        try {
          const response = await axios.get('/api/rooms');
          setRooms(response.data);
        } catch (error) {
          console.error('Lỗi khi lấy danh sách phòng:', error);
        }
      };

      const fetchInventory = async () => {
        try {
          const response = await axios.get('/api/inventory');
          setInventory(response.data);
        } catch (error) {
          console.error('Lỗi khi lấy danh sách kho:', error);
        }
      };

      const fetchReports = async () => {
        try {
          const response = await axios.get('/api/reports');
          setReport(response.data);
        } catch (error) {
          console.error('Lỗi khi lấy báo cáo:', error);
        }
      };

      const handleCheckIn = async (roomId) => {
        try {
          await axios.post('/api/checkin', { roomId, items: checkInData.items, checkInTime: new Date() });
          fetchRooms();
          setCheckInData({ items: [], surcharge: { amount: 0, note: '' } });
          setSelectedRoom(null);
        } catch (error) {
          alert('Lỗi khi check-in: ' + error.response?.data?.error || error.message);
        }
      };

      const handleCheckOut = async (roomId) => {
        try {
          const response = await axios.post('/api/checkout', { roomId, surcharge: checkInData.surcharge });
          alert(`Hóa đơn: ${response.data.total.toLocaleString('vi-VN')} VND`);
          fetchRooms();
          setCheckInData({ items: [], surcharge: { amount: 0, note: '' } });
          setSelectedRoom(null);
        } catch (error) {
          alert('Lỗi khi check-out: ' + error.response?.data?.error || error.message);
        }
      };

      const handleAdminLogin = () => {
        if (pin === '123456') {
          setIsAdmin(true);
          setPin('');
        } else {
          alert('Mã PIN không đúng');
        }
      };

      const handlePriceUpdate = async () => {
        try {
          await axios.post('/api/prices', prices);
          alert('Cập nhật giá thành công');
        } catch (error) {
          alert('Lỗi khi cập nhật giá: ' + error.response?.data?.error || error.message);
        }
      };

      const handleExcelImport = async (event) => {
        try {
          const file = event.target.files[0];
          const formData = new FormData();
          formData.append('file', file);
          await axios.post('/api/inventory/import', formData);
          fetchInventory();
          alert('Nhập kho thành công');
        } catch (error) {
          alert('Lỗi khi nhập kho: ' + error.response?.data?.error || error.message);
        }
      };

      const getRoomColor = (status) => {
        switch (status) {
          case 'occupied': return 'bg-red-500';
          case 'vacant': return 'bg-green-500';
          case 'dirty': return 'bg-yellow-500';
          default: return 'bg-gray-500';
        }
      };

      return (
        <div className="container mx-auto p-4">
          <h1 className="text-3xl font-bold mb-4">Quản Lý Nhà Nghỉ</h1>

          {/* Đăng nhập Admin */}
          {!isAdmin && (
            <div className="mb-4">
              <input
                type="password"
                placeholder="Nhập mã PIN Admin"
                value={pin}
                onChange={(e) => setPin(e.target.value)}
                className="border p-2 mr-2 rounded"
              />
              <button onClick={handleAdminLogin} className="bg-blue-500 text-white p-2 rounded">Đăng nhập</button>
            </div>
          )}

          {/* Danh sách phòng */}
          <div className="mb-8">
            <h2 className="text-2xl font-semibold mb-2">Trạng Thái Phòng</h2>
            {['2', '3', '4'].map(floor => (
              <div key={floor} className="mb-4">
                <h3 className="text-xl font-medium">Tầng {floor}</h3>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                  {rooms.filter(room => room.floor === floor).map(room => (
                    <div
                      key={room._id}
                      className={`p-4 rounded ${getRoomColor(room.status)} text-white cursor-pointer text-center`}
                      onClick={() => setSelectedRoom(room)}
                    >
                      Phòng {room.number}
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>

          {/* Modal Check-in/Check-out */}
          {selectedRoom && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <div className="bg-white p-6 rounded max-w-md w-full">
                <h3 className="text-xl mb-4">Quản Lý Phòng {selectedRoom.number}</h3>
                <select
                  multiple
                  onChange={(e) => setCheckInData({
                    ...checkInData,
                    items: Array.from(e.target.selectedOptions, option => ({
                      itemId: option.value,
                      quantity: 1,
                    }))
                  })}
                  className="border p-2 mb-4 w-full"
                >
                  {inventory.map(item => (
                    <option key={item._id} value={item._id}>
                      {item.name} (Tồn: {item.quantity}, Giá: {item.salePrice ? item.salePrice.toLocaleString('vi-VN') : 'Chưa đặt'})
                    </option>
                  ))}
                </select>
                <div className="mb-4">
                  <input
                    type="number"
                    placeholder="Số tiền phụ thu (VND)"
                    value={checkInData.surcharge.amount}
                    onChange={(e) => setCheckInData({
                      ...checkInData,
                      surcharge: { ...checkInData.surcharge, amount: parseInt(e.target.value) || 0 }
                    })}
                    className="border p-2 mb-2 w-full"
                  />
                  <input
                    type="text"
                    placeholder="Ghi chú phụ thu"
                    value={checkInData.surcharge.note}
                    onChange={(e) => setCheckInData({
                      ...checkInData,
                      surcharge: { ...checkInData.surcharge, note: e.target.value }
                    })}
                    className="border p-2 w-full"
                  />
                </div>
                <button
                  onClick={() => handleCheckIn(selectedRoom._id)}
                  className="bg-green-500 text-white p-2 rounded mr-2"
                >
                  Check-In
                </button>
                <button
                  onClick={() => handleCheckOut(selectedRoom._id)}
                  className="bg-red-500 text-white p-2 rounded mr-2"
                >
                  Check-Out
                </button>
                <button
                  onClick={() => setSelectedRoom(null)}
                  className="bg-gray-500 text-white p-2 rounded"
                >
                  Đóng
                </button>
              </div>
            </div>
          )}

          {/* Admin Panel */}
          {isAdmin && (
            <div className="mb-8">
              <h2 className="text-2xl font-semibold mb-2">Bảng Quản Trị</h2>
              <div className="mb-4">
                <h3 className="text-xl">Cài Đặt Giá</h3>
                <input
                  type="number"
                  placeholder="Giá giờ đầu (VND)"
                  value={prices.firstHour}
                  onChange={(e) => setPrices({ ...prices, firstHour: parseInt(e.target.value) || 0 })}
                  className="border p-2 mr-2 mb-2 w-full"
                />
                <input
                  type="number"
                  placeholder="Giá giờ tiếp theo (VND)"
                  value={prices.extraHour}
                  onChange={(e) => setPrices({ ...prices, extraHour: parseInt(e.target.value) || 0 })}
                  className="border p-2 mr-2 mb-2 w-full"
                />
                <input
                  type="number"
                  placeholder="Giá qua đêm (VND)"
                  value={prices.overnight}
                  onChange={(e) => setPrices({ ...prices, overnight: parseInt(e.target.value) || 0 })}
                  className="border p-2 mr-2 mb-2 w-full"
                />
                <button onClick={handlePriceUpdate} className="bg-blue-500 text-white p-2 rounded">Cập nhật giá</button>
              </div>
              <div>
                <h3 className="text-xl">Nhập Kho (Excel)</h3>
                <input type="file" accept=".xlsx" onChange={handleExcelImport} className="mb-4" />
              </div>
              <div>
                <h3 className="text-xl">Cài Đặt Giá Sản Phẩm</h3>
                {inventory.map(item => (
                  <div key={item._id} className="flex items-center mb-2">
                    <span className="mr-2">{item.name} (Tồn: {item.quantity})</span>
                    <input
                      type="number"
                      placeholder="Giá bán (VND)"
                      defaultValue={item.salePrice}
                      onBlur={(e) => axios.post('/api/inventory/price', { id: item._id, salePrice: parseInt(e.target.value) || 0 })}
                      className="border p-2 w-32"
                    />
                    {!item.salePrice && <span className="text-red-500 ml-2">Chưa đặt giá</span>}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Báo cáo */}
          <div>
            <h2 className="text-2xl font-semibold mb-2">Báo Cáo Thu Chi</h2>
            <p>Doanh thu ngày: {report.daily.toLocaleString('vi-VN')} VND</p>
            <p>Doanh thu tuần: {report.weekly.toLocaleString('vi-VN')} VND</p>
            <p>Doanh thu tháng: {report.monthly.toLocaleString('vi-VN')} VND</p>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
